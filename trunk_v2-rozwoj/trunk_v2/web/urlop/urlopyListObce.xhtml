<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                template="/templates/templateGPF.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions">
    <ui:define name="tytul">
        <h3 align="center">Obce wnioski urlopowe</h3>
    </ui:define>
    <ui:define name="content" id="content">
        <h:form id="center">
            <p:defaultCommand target="dummy"/>
            <p:commandButton id="dummy" process="@none" global="false" style="display:none;"/>

            <p:fieldset id="formWprow" collapsed="#{UrlopObceM.urlop.id==null}" toggleable="true" legend="Dodaj/Edytuj wniosek (zwiń/rozwiń)" widgetVar="formWprowV">
                <p:panelGrid columns="2" rendered="#{fn:length(UrlopObceM.urlop.uzytkownik.wnLimity.ulimit)!=0}" id="limit">
                    Dostępny urlop:<strong>#{UrlopObceM.urlop.uzytkownik.wnLimity.ulimit}</strong>
                </p:panelGrid>
                <p:panelGrid columns="3" id="form" columnClasses="column1, column2">
                    <p:outputLabel for="name" value="Imię i nazwisko: "/>
                    <p:selectOneMenu id="name" value="#{UrlopObceM.urlop.uzytkownik}" converter="#{UzytkownikConv}">
                        <p:ajax listener="#{UrlopObceM.changeUserList}" update="form"/>
                        <f:selectItem itemLabel="wybierz" noSelectionOption="true"/>
                        <f:selectItems value="#{login.zalogowany.obceWnioski}" var="struktura" itemValue="#{struktura.userId}" itemLabel="#{struktura.userId.fullname}" />
                    </p:selectOneMenu>
                    <p:message for="name" styleClass="error" />

                    <p:outputLabel for="rodzajW" value="Zwracam się z prośbą o udzielenie urlopu (rodzaj):"/>
                    <p:selectOneMenu id="rodzajW" value="#{UrlopObceM.urlop.rodzajId}" converter="#{WnRodzajeConv}">
                        <f:selectItems value="#{UrlopObceM.rodzajeC.findWnRodzajeEntities}" var="rodzaj" itemValue="#{rodzaj}" itemLabel="#{rodzaj.opis}"/>
                        <p:ajax update="form" process="rodzajW"/>
                    </p:selectOneMenu>
                    <p:message for="rodzajW" styleClass="error" />

                    <p:outputLabel value="Cały dzień?" rendered="#{UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:inputSwitch id="calyDzien" value="#{UrlopObceM.calyDzien}" offLabel="Nie" onLabel="Tak" rendered="#{UrlopObceM.urlop.rodzajId.id!=40}">
                        <p:ajax event="change" update="form" process="calyDzien" rendered="#{UrlopObceM.urlop.rodzajId.id!=40}"/>
                    </p:inputSwitch>
                    <p:outputLabel rendered="#{UrlopObceM.urlop.rodzajId.id!=40}"/>

                    <p:outputLabel for="data_od" value="Data od:" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:calendar id="data_od" value="#{UrlopObceM.urlop.dataOd}" pattern="yyyy-MM-dd" locale="pl" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:message for="data_od" styleClass="error" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>

                    <p:outputLabel for="data_do" value="Data do:" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:calendar id="data_do" value="#{UrlopObceM.urlop.dataDo}" pattern="yyyy-MM-dd" locale="pl" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:message for="data_do" styleClass="error" rendered="#{UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>

                    <p:outputLabel for="data_url" value="Dzień urlopu:" rendered="#{!UrlopObceM.calyDzien and UrlopObceM.urlop.rodzajId.id!=40}"/>
                    <p:outputLabel for="data_url" value="Dzień nadgodzin:" rendered="#{UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:calendar id="data_url" value="#{UrlopObceM.dataUrlopu}" pattern="yyyy-MM-dd" locale="pl" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:message for="data_url" styleClass="error" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>

                    <p:outputLabel value="Godzina od:" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:calendar id="data_od_godz" value="#{UrlopObceM.godzOdT}" pattern="HH:00" timeOnly="true" locale="pl" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:message for="data_od_godz" styleClass="error" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>

                    <p:outputLabel for="data_do_godz" value="Godzina do:" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:calendar id="data_do_godz" value="#{UrlopObceM.godzDoT}" pattern="HH:00" timeOnly="true" locale="pl" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:message for="data_do_godz" styleClass="error" rendered="#{!UrlopObceM.calyDzien or UrlopObceM.urlop.rodzajId.id==40}"/>

                    <p:outputLabel for="extraemail" value="Czy wysłać informacje na dodatkowe e-maile?" rendered="#{fn:length(UrlopObceM.urlop.uzytkownik.struktura.extraemail)>0}"/>
                    <h:panelGroup rendered="#{fn:length(UrlopObceM.urlop.uzytkownik.struktura.extraemail)>0}">
                        <h:selectBooleanCheckbox value="#{UrlopObceM.urlop.extraemail}"/>
                        <h:outputText id="extraemail" value="#{UrlopObceM.urlop.uzytkownik.struktura.extraemail}"/>
                    </h:panelGroup>
                    <p:message for="extraemail" styleClass="error" rendered="#{fn:length(UrlopObceM.urlop.uzytkownik.struktura.extraemail)>0}"/>

                    <p:outputLabel for="pracodawca" value="Pracodawca: " rendered="#{UrlopObceM.urlop.rodzajId.id==40}"/>
                    <p:inputSwitch id="pracodawca" value="#{UrlopObceM.urlop.pracodawca}" rendered="#{UrlopObceM.urlop.rodzajId.id==40}" onLabel="Tak" offLabel="Nie"/>
                    <p:message for="pracodawca" styleClass="error" rendered="#{UrlopObceM.urlop.rodzajId.id==40}"/>

                    <p:outputLabel for="kwota" value="Kwota: " rendered="#{UrlopObceM.urlop.rodzajId.id==30}"/>
                    <p:inputText id="kwota" value="#{UrlopObceM.urlop.kwotaWs}" rendered="#{UrlopObceM.urlop.rodzajId.id==30}">
                        <f:convertNumber type="currency" minFractionDigits="2" pattern="#0,00" groupingUsed="false"/>
                        <p:watermark for="kwota" value="99 999,99" />
                    </p:inputText>
                    <p:message for="kwota" styleClass="error" rendered="#{UrlopObceM.urlop.rodzajId.id==30}"/>

                    <p:outputLabel for="infoDod" value="Informacje dodatkowe: "/>
                    <h:inputTextarea id="infoDod" value="#{UrlopObceM.urlop.infoDod}" cols="52"/>
                    <p:message for="infoDod" styleClass="error" />

                    <p:outputLabel for="miejsce" value="Delegacja - miejsce: " rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <h:inputText id="miejsce" value="#{UrlopObceM.urlop.miejsce}" size="50" rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <p:message for="miejsce" styleClass="error"  rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>

                    <p:outputLabel for="cel" value="Delegacja - cel: " rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <h:inputText id="cel" value="#{UrlopObceM.urlop.cel}" size="50" rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <p:message for="cel" styleClass="error"  rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>

                    <p:outputLabel for="srodekLok" value="Delegacja - srodek lokomocji: " rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <h:inputText id="srodekLok" value="#{UrlopObceM.urlop.srodekLok}" size="50" rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>
                    <p:message for="srodekLok" styleClass="error"  rendered="#{UrlopObceM.urlop.rodzajId.id==5 or UrlopObceM.urlop.rodzajId.id==6}"/>

                </p:panelGrid>
                <center>
                    <p:message for="dodaj" styleClass="error"/>
                    <p:commandButton id="dodaj" value="Zapisz wniosek" action="#{UrlopObceM.dodaj}" update=":infoForm:messages, formTab, formWprow" process="formWprow" oncomplete="PF('tableV').clearFilters()"/>
                </center>
            </p:fieldset>

            <p:outputPanel id="formTab" layout="block">
                <p:dataTable value="#{UrlopObceM.urlopyList}" var="urlop" id="table" paginator="true" rowsPerPageTemplate="10, 20, 50, 100" rows="10" sortBy="#{urlop.id}" sortOrder="descending" widgetVar="tableV" emptyMessage="brak danych">
                    <p:column headerText="Wniosek pracownika" filterBy="#{urlop.uzytkownik.fullname}" filterMatchMode="contains">
                        <h:outputText value="#{urlop.uzytkownik.fullname}"/>
                    </p:column>
                    <p:column headerText="Wniosek złożony przez">
                        <h:outputText value="#{urlop.przyjmujacy.fullname}" rendered="#{urlop.przyjmujacy!=null}"/>
                        <h:outputText value="#{urlop.uzytkownik.fullname}" rendered="#{urlop.przyjmujacy==null}"/>
                    </p:column>
                    <p:column headerText="Nr wniosku" filterBy="#{urlop.nrWniosku}" filterMatchMode="contains">
                        <h:outputText value="#{urlop.nrWniosku}"/>
                        <p:separator/>
                        <h:outputText value="#{urlop.infoDod}" rendered="#{fn:length(urlop.infoDod)>0}"/>
                    </p:column>
                    <p:column headerText="Rodzaj" filterBy="#{urlop.rodzajId.opis}" filterMatchMode="contains">
                        <h:outputText value="#{urlop.rodzajId.opis}"/>
                    </p:column>
                    <p:column headerText="Wprowadzony" sortBy="#{urlop.dataWprowadzenia}">
                        <h:outputText value="#{urlop.dataWprowadzenia}"><f:convertDateTime type="date" pattern="yyyy-MM-dd HH:mm:ss" timeZone="CET"/></h:outputText>
                    </p:column>
                    <p:column headerText="Od Do" sortBy="#{urlop.dataOd}">
                        <h:outputText value="#{urlop.dataOd}"><f:convertDateTime type="date" pattern="yyyy-MM-dd HH:mm" locale="#{UrlopObceM.locale}" timeZone="CET"/></h:outputText>
                        <p:separator/>
                        <h:outputText value="#{urlop.dataDo}"><f:convertDateTime type="date" pattern="yyyy-MM-dd HH:mm" locale="#{UrlopObceM.locale}" timeZone="CET"/></h:outputText>
                    </p:column>
                    <p:column headerText="Status" filterBy="#{urlop.statusId.opis}" filterMatchMode="contains" style="background-color: #{urlop.statusId.kolor} ; text-align: center">
                        <h:outputText value="#{urlop.statusId.opis}"/>
                    </p:column>
                    <p:column headerText="Akceptant" filterBy="#{urlop.akceptant.fullname}" filterMatchMode="contains">
                        <h:outputText value="#{urlop.akceptant.fullname}"/>
                    </p:column>
                    <p:column headerText="Więcej" style="width:36px">
                        <p:rowToggler id="wiecej"/>
                        <p:tooltip for="wiecej" value="rozwiń"/>
                    </p:column>
                    <p:rowExpansion>
                        <p:panel header="Informacje dodatkowe" rendered="#{urlop.rodzajId.id==5 or urlop.rodzajId.id==6}">
                            <p:panelGrid columns="2" columnClasses="column1p, column2p">
                                <p:outputLabel for="miejsce" value="Miejsce: " />
                                <h:outputText id="miejsce" value="#{urlop.miejsce}" />

                                <p:outputLabel for="cel" value="Cel: " />
                                <h:outputText id="cel" value="#{urlop.cel}" />

                                <p:outputLabel for="srodekLok" value="Środek lokomocji: " />
                                <h:outputText id="srodekLok" value="#{urlop.srodekLok}"/>
                            </p:panelGrid>
                        </p:panel>
                        <p:panel header="Informacje dodatkowe" rendered="#{urlop.rodzajId.id==30}">
                            <p:panelGrid columns="2" columnClasses="column1p, column2p">
                                <p:outputLabel value="Kwota: " />
                                <h:outputText value="#{urlop.kwotaWs}">
                                    <f:convertNumber currencyCode="PLN" type="currency" minFractionDigits="2"/>
                                </h:outputText>
                            </p:panelGrid>
                        </p:panel>
                        <p:panel header="Informacje dodatkowe" rendered="#{urlop.rodzajId.id==40}">
                            <p:panelGrid columns="2" columnClasses="column1p, column2p">
                                <p:outputLabel value="Pracodawca: " />
                                <p:inputSwitch value="#{urlop.pracodawca}" offLabel="Nie" onLabel="Tak" disabled="true"/>
                            </p:panelGrid>
                        </p:panel>
                        <p:panel header="Historia" rendered="#{fn:length(urlop.wnHistoriaList)>0}">
                            <p:dataTable id="histTab" value="#{urlop.wnHistoriaList}" var="hist">
                                <p:column headerText="Data zmiany">
                                    <h:outputText value="#{hist.dataZmiany}"><f:convertDateTime type="date" pattern="yyyy-MM-dd HH:mm:ss" timeZone="CET"/></h:outputText>
                                </p:column>
                                <p:column headerText="Zmianę wykonał">
                                    <h:outputText value="#{hist.zmieniajacy.fullname}"/>
                                </p:column>
                                <p:column headerText="Status" style="alignment-adjust: central">
                                    <h:outputText value="#{hist.statusId.opis}"/>
                                </p:column>
                                <p:column headerText="Opis zmiany">
                                    <p:panel>
                                        <h:outputText value="#{hist.opisZmiany}" id="opis"/>
                                    </p:panel>
                                </p:column>
                                <p:column headerText="Akceptant">
                                    <h:outputText value="#{hist.akceptant.fullname}"/>
                                </p:column>
                            </p:dataTable>
                        </p:panel>
                    </p:rowExpansion>
                    <p:column headerText="Akcje" style="width: 90px">
                        <p:tooltip for="imgEd" value="Edytuj"/>
                        <p:tooltip for="imgAn" value="Anuluj"/>
                        <p:tooltip for="imgDe" value="Usun"/>
                        <p:tooltip for="imgWy" value="Wyślij"/>
                        <p:commandButton id="imgDe" rendered="#{urlop.statusId.id==1 or urlop.statusId.id==5}" update=":center:formTab, :infoForm:messages" process="imgDe" 
                                         icon="ui-icon-trash" action="#{UrlopObceM.usun}" oncomplete="PF('tableV').filter();">
                            <p:confirm header="Potwierdzenie" message="Czy jesteś pewny?" icon="ui-icon-alert" />
                            <f:setPropertyActionListener target="#{UrlopObceM.urlop}" value="#{urlop}"/>
                        </p:commandButton>
                        <p:commandButton id="imgEd" rendered="#{urlop.statusId.id==1 or urlop.statusId.id==5}" update=":center:formWprow, :infoForm:messages" process="imgEd" icon="ui-icon-pencil">
                            <f:setPropertyActionListener target="#{UrlopObceM.urlop}" value="#{urlop}"/>
                            <f:setPropertyActionListener target="#{UrlopObceM.godzOdT}" value="#{urlop.dataOd}"/>
                            <f:setPropertyActionListener target="#{UrlopObceM.godzDoT}" value="#{urlop.dataDo}"/>
                            <f:setPropertyActionListener target="#{UrlopObceM.dataUrlopu}" value="#{urlop.dataOd}"/>
                            <f:setPropertyActionListener target="#{UrlopObceM.calyDzien}" value="#{urlop.calyDzien}"/>
                        </p:commandButton>
                        <p:commandButton id="imgWy" action="#{UrlopObceM.wyslij}" rendered="#{urlop.statusId.id==1 or urlop.statusId.id==5}" update=":center:formTab, :infoForm:messages" 
                                         process="@this" icon="ui-icon-play" oncomplete="PF('tableV').filter();">
                            <f:setPropertyActionListener target="#{UrlopObceM.urlop}" value="#{urlop}"/>
                        </p:commandButton>
                        <p:message for="imgWy"/>
                        <p:commandButton id="imgAn" action="#{UrlopObceM.anuluj}" rendered="#{urlop.statusId.id==3}" update=":center:formTab, :infoForm:messages" 
                                         oncomplete="PF('tableV').filter();" process="@this" icon="ui-icon-circle-minus">
                            <f:setPropertyActionListener target="#{UrlopObceM.urlop}" value="#{urlop}"/>
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
            </p:outputPanel>
        </h:form>
    </ui:define>
</ui:composition>
